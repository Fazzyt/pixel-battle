<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="pixel-battle 2.0 - –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∏—Ç–≤–∞ –∑–∞ –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å —Å —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é">
    <title>pixel-battle 2.0 - –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</title>
    
    <!-- Preload –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
    <link rel="modulepreload" href="static/js/app.js">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="static/css/modern.css">
    
    <!-- PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç (–ø–æ–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω) -->
    <!-- <link rel="manifest" href="static/manifest.json"> -->
    <meta name="theme-color" content="#2196F3">
    
    <!-- –ò–∫–æ–Ω–∫–∏ (–ø–æ–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω—ã) -->
    <!-- <link rel="apple-touch-icon" href="static/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/icons/favicon-16x16.png"> -->
    
    <!-- Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <noscript>
        <style>
            .js-only { display: none !important; }
            .no-js-fallback { display: block !important; }
        </style>
    </noscript>
</head>
<body oncontextmenu="return false;" class="loading">
    
    <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
    <div id="app-loader" class="app-loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h2>pixel-battle 2.0</h2>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã...</p>
            <div class="loader-progress">
                <div class="loader-progress-bar"></div>
            </div>
        </div>
    </div>
    
    <!-- Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ JS -->
    <div class="no-js-fallback" style="display: none;">
        <div class="error-container">
            <h1>JavaScript Required</h1>
            <p>pixel-battle 2.0 —Ç—Ä–µ–±—É–µ—Ç –≤–∫–ª—é—á–µ–Ω–Ω—ã–π JavaScript –¥–ª—è —Ä–∞–±–æ—Ç—ã.</p>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ JavaScript –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.</p>
        </div>
    </div>
    
    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="app js-only" style="display: none;">
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ö–æ–ª—Å—Ç–∞ -->
        <div id="canvas-container" class="canvas-container">
            <canvas id="canvas" class="main-canvas"></canvas>
            
            <!-- –û–≤–µ—Ä–ª–µ–∏ —Ö–æ–ª—Å—Ç–∞ -->
            <div class="canvas-overlays">
                <!-- –ö—É—Ä—Å–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
                <div id="cursor-info" class="cursor-info"></div>
            </div>
        </div>
        
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
        <div class="top-bar">
            <div class="info-panel">
                <div id="online-counter" class="info-item">
                    <span class="info-icon">üë•</span>
                    <span class="info-text">Online: 0</span>
                </div>
                
                <div id="coordinates" class="info-item">
                    <span class="info-icon">üìç</span>
                    <span class="info-text">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</span>
                </div>
                
                <div id="connection-status" class="info-item">
                    <span class="info-icon status-indicator" data-status="disconnected">üî¥</span>
                    <span class="info-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="control-buttons">
                <button id="toggle-sidebar" class="control-btn" title="–°–∞–π–¥–±–∞—Ä (B)">
                    <span>üìã</span>
                </button>
            </div>
        </div>
        
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="side-panel">
            <!-- –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ -->
            <div class="color-palette-container">
                <h3 class="panel-title">–¶–≤–µ—Ç–∞</h3>
                <div class="color-palette" id="color-palette">
                    {% for color in colors %}
                    <div class="color-option" 
                         data-color="{{ color }}" 
                         style="background-color: {{ color }}"
                         title="{{ color }}"
                         tabindex="0">
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–∏–∫—Å–µ–ª–µ -->
            <div class="pixel-info-container">
                <h3 class="panel-title">–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–∏–∫—Å–µ–ª—å</h3>
                <div id="pixel-info" class="pixel-info">
                    <p class="pixel-coords">–ù–µ –≤—ã–±—Ä–∞–Ω</p>
                    <div class="pixel-preview"></div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
            <div class="action-container">
                <button id="confirm-pixel" class="confirm-btn" disabled>
                    <span class="btn-icon">‚ú®</span>
                    <span class="btn-text">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
                </button>
                
                <button id="center-canvas-sidebar" class="center-btn" title="–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ (Space)">
                    <span class="btn-icon">üéØ</span>
                    <span class="btn-text">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
                </button>
            </div>
            
            <!-- Cooldown –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="cooldown-container">
                <div id="cooldown" class="cooldown-info">
                    –°–ª–µ–¥—É—é—â–∏–π –ø–∏–∫—Å–µ–ª—å —á–µ—Ä–µ–∑: 0 —Å–µ–∫—É–Ω–¥.
                </div>
                <div class="cooldown-progress">
                    <div id="cooldown-progress-bar" class="cooldown-progress-bar"></div>
                </div>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à -->
            <div class="hotkeys-panel">
                <h3 class="panel-title">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h3>
                <div class="hotkeys-list">
                    <div class="hotkey-item">
                        <kbd>B</kbd> <span>–°–∞–π–¥–±–∞—Ä</span>
                    </div>
                    <div class="hotkey-item">
                        <kbd>Space</kbd> <span>–¶–µ–Ω—Ç—Ä</span>
                    </div>
                    <div class="hotkey-item">
                        <kbd>+/-</kbd> <span>–ó—É–º</span>
                    </div>
                    <div class="hotkey-item">
                        <kbd>–°—Ç—Ä–µ–ª–∫–∏</kbd> <span>–î–≤–∏–∂–µ–Ω–∏–µ</span>
                    </div>
                    <div class="hotkey-item">
                        <kbd>Enter</kbd> <span>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="mobile-controls" id="mobile-controls">
            <button id="mobile-toggle" class="mobile-toggle">
                <span>‚öôÔ∏è</span>
            </button>
            <div class="mobile-panel" id="mobile-panel" style="display: none;">
                <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--text-primary);">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="window.pixelBattleApp?.centerCanvas()" style="padding: 8px 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        üéØ –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    
                    <button onclick="window.pixelBattleApp?.toggleSidebar()" style="padding: 8px 12px; background: var(--surface-dark); color: var(--text-primary); border: 1px solid var(--divider); border-radius: 4px; cursor: pointer;">
                        üìã –°–∞–π–¥–±–∞—Ä
                    </button>
                    
                    <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                        <div>Space - –¶–µ–Ω—Ç—Ä</div>
                        <div>B - –°–∞–π–¥–±–∞—Ä</div>
                        <div>–°—Ç—Ä–µ–ª–∫–∏ - –î–≤–∏–∂–µ–Ω–∏–µ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="context-menu" class="context-menu" style="display: none;">
            <div class="context-menu-item" data-action="place-pixel">
                –ü–æ—Å—Ç–∞–≤–∏—Ç—å –ø–∏–∫—Å–µ–ª—å
            </div>
            <div class="context-menu-item" data-action="get-info">
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∏–∫—Å–µ–ª–µ
            </div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" data-action="center-here">
                –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–¥–µ—Å—å
            </div>
        </div>
    </div>
    
    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –º–æ–¥—É–ª–µ–π
        window.CONFIG = {
            CANVAS_WIDTH: {{ canvas_width }},
            CANVAS_HEIGHT: {{ canvas_height }},
            PIXEL_SIZE: {{ pixel_size }},
            COOLDOWN_TIME: {{ cooldown_time }},
            MIN_SCALE: 0.1,
            MAX_SCALE: 20,
            DEFAULT_COLOR: '{{ colors[0] if colors else "#000000" }}',
            COLORS: {{ colors | tojson }},
            VERSION: '2.0.0',
            BUILD: '{{ build_timestamp | default("dev") }}',
            DEBUG: {{ 'true' if debug else 'false' }}
        };
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        let loaderHidden = false;
        window.loadingProgress = {
            total: 7,
            loaded: 0,
            update: function() {
                this.loaded++;
                const percent = (this.loaded / this.total) * 100;
                const progressBar = document.querySelector('.loader-progress-bar');
                if (progressBar) {
                    progressBar.style.width = percent + '%';
                }
                
                if (this.loaded >= this.total && !loaderHidden) {
                    this.hideLoader();
                }
            },
            hideLoader: function() {
                if (loaderHidden) return;
                loaderHidden = true;
                
                console.log('üîÑ Hiding loader...');
                
                const loader = document.getElementById('app-loader');
                const app = document.getElementById('app');
                
                if (loader) {
                    loader.style.display = 'none';
                    console.log('‚úÖ Loader hidden');
                }
                
                if (app) {
                    app.style.display = 'block';
                    document.body.classList.remove('loading');
                    console.log('‚úÖ App shown');
                }
            }
        };
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º loader —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –æ–Ω –µ—â–µ –≤–∏–¥–µ–Ω
        setTimeout(() => {
            if (!loaderHidden) {
                console.log('‚è∞ Force hiding loader after timeout');
                window.loadingProgress.hideLoader();
            }
        }, 3000);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
        window.featureSupport = {
            modules: 'noModule' in HTMLScriptElement.prototype,
            webgl: !!window.WebGLRenderingContext,
            websockets: 'WebSocket' in window,
            canvas: !!document.createElement('canvas').getContext,
            es6: (function() {
                try {
                    new Function('(a = 0) => a');
                    return true;
                } catch (err) {
                    return false;
                }
            })()
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
        if (!window.featureSupport.modules || !window.featureSupport.websockets || !window.featureSupport.canvas) {
            document.querySelector('.no-js-fallback').style.display = 'block';
            document.querySelector('.no-js-fallback h1').textContent = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            document.querySelector('.no-js-fallback p').textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–µ–±-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã pixel-battle 2.0.';
            document.getElementById('app-loader').style.display = 'none';
        }
    </script>
    
    <!-- –°—Ç–∏–ª–∏ –¥–ª—è loader –∏ –±–∞–∑–æ–≤–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ -->
    <style>
        .app-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        .loader-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
        }
        
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        
        .loader-content h2 {
            margin: 0 0 10px;
            font-size: 28px;
            font-weight: 700;
        }
        
        .loader-content p {
            margin: 0 0 30px;
            font-size: 16px;
            opacity: 0.8;
        }
        
        .loader-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loader-progress-bar {
            width: 0%;
            height: 100%;
            background: white;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        .error-container h1 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º app –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ */
        .app {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        body:not(.loading) .app {
            opacity: 1;
        }
    </style>
    
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞) -->
    <script>
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞
        if (window.CONFIG) {
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            Object.assign(window.CONFIG, {
                MIN_SCALE: 0.1,
                MAX_SCALE: 20,
                VERSION: '2.0.0',
                DEBUG: false
            });
        }
    </script>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script type="module" src="static/js/app.js"></script>
    
    <!-- Service Worker –¥–ª—è PWA (–ø–æ–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω) -->
    <!--
    <script>
        if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered:', reg))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>
    -->
</body>
</html>
